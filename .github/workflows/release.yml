name: Release

on:
  # 每天 UTC 02:00 检查版本更新
  schedule:
    - cron: '0 2 * * *'
  # 允许手动触发
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # 检查版本是否需要发布
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      should-release: ${{ steps.check-tag.outputs.should-release }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 需要完整历史来检查 tag

      - name: Get version from Cargo.toml
        id: get-version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Check if tag exists
        id: check-tag
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping release"
            echo "should-release=false" >> $GITHUB_OUTPUT
          else
            echo "Tag v$VERSION does not exist, will create release"
            echo "should-release=true" >> $GITHUB_OUTPUT
          fi

  # 创建 Git tag
  create-tag:
    name: Create Tag
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.create-tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        id: create-tag
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TAG="v$VERSION"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Created tag: $TAG"

  # 构建多平台二进制并发布到 GitHub Releases
  build-release:
    name: Build Release Binaries
    needs: [check-version, create-tag]
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            suffix: ''
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            suffix: ''
          - os: macos-latest
            target: x86_64-apple-darwin
            suffix: ''
          - os: macos-latest
            target: aarch64-apple-darwin
            suffix: ''
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            suffix: '.exe'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux ARM)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package binary (Unix)
        if: matrix.suffix == ''
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          TARGET="${{ matrix.target }}"
          mkdir -p "mdp-$VERSION-$TARGET"
          cp "target/$TARGET/release/mdp" "mdp-$VERSION-$TARGET/"
          cp README.md LICENSE "mdp-$VERSION-$TARGET/" 2>/dev/null || true
          tar czf "mdp-$VERSION-$TARGET.tar.gz" "mdp-$VERSION-$TARGET"
          echo "asset_name=mdp-$VERSION-$TARGET.tar.gz" >> $GITHUB_ENV

      - name: Package binary (Windows)
        if: matrix.suffix == '.exe'
        run: |
          $VERSION = "${{ needs.check-version.outputs.version }}"
          $TARGET = "${{ matrix.target }}"
          New-Item -ItemType Directory -Path "mdp-$VERSION-$TARGET" -Force
          Copy-Item "target\$TARGET\release\mdp.exe" "mdp-$VERSION-$TARGET\"
          Copy-Item README.md "mdp-$VERSION-$TARGET\" -ErrorAction SilentlyContinue
          Copy-Item LICENSE "mdp-$VERSION-$TARGET\" -ErrorAction SilentlyContinue
          Compress-Archive -Path "mdp-$VERSION-$TARGET" -DestinationPath "mdp-$VERSION-$TARGET.zip"
          echo "asset_name=mdp-$VERSION-$TARGET.zip" >> $env:GITHUB_ENV

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-tag.outputs.tag }}
          files: ${{ env.asset_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 发布到 crates.io
  publish-crates:
    name: Publish to crates.io
    needs: [check-version, create-tag, build-release]
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: publish-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Verify package
        run: cargo publish --dry-run

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # 通知发布结果
  notify:
    name: Notify Release
    needs: [check-version, build-release, publish-crates]
    if: always() && needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Release Summary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          BUILD_STATUS="${{ needs.build-release.result }}"
          PUBLISH_STATUS="${{ needs.publish-crates.result }}"
          
          echo "## Release v$VERSION Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| crates.io | $PUBLISH_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$BUILD_STATUS" == "success" ] && [ "$PUBLISH_STATUS" == "success" ]; then
            echo "✅ All releases completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some releases failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
