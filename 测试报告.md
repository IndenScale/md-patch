# mdp å·¥å…·æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2026-02-20  
**æµ‹è¯•ç‰ˆæœ¬**: mdp 0.1.0  
**æµ‹è¯•ç¯å¢ƒ**: macOS (ARM64)

---

## 1. æ‰§è¡Œæ‘˜è¦

`mdp` æ˜¯ä¸€ä¸ªæœ‰è‰¯å¥½è®¾è®¡ç†å¿µçš„ Markdown è¡¥ä¸å·¥å…·ï¼Œæ ¸å¿ƒæ¦‚å¿µï¼ˆè¯­ä¹‰å¯»å€ã€fingerprint å®‰å…¨æœºåˆ¶ã€åŸå­æ“ä½œï¼‰è®¾è®¡æ­£ç¡®ã€‚ä½†åœ¨å®ç°ç»†èŠ‚ä¸Šå­˜åœ¨ä¸€äº›éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯**å¹‚ç­‰æ€§æ‰¿è¯ºæœªå…‘ç°**è¿™ä¸€å…³é”®ç¼ºé™·ã€‚

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|:----:|------|
| è®¾è®¡ç†å¿µ | â­â­â­â­â­ | æ­£ç¡®ä¸”å…ˆè¿› |
| åŠŸèƒ½å®ç° | â­â­â­ | æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ï¼Œæœ‰ç»†èŠ‚é—®é¢˜ |
| ä»£ç è´¨é‡ | â­â­â­â­ | Rust ä»£ç è§„èŒƒï¼Œæœ‰å•å…ƒæµ‹è¯• |
| æ–‡æ¡£ | â­â­â­ | éœ€è¦ä¿®æ­£å’Œè¡¥å…… |
| ç”Ÿäº§å°±ç»ª | â­â­â­ | éœ€è¦ä¿®å¤å¹‚ç­‰æ€§å’Œæ ¼å¼é—®é¢˜ |

---

## 2. åŠŸèƒ½æµ‹è¯•ç»“æœ

### 2.1 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | æµ‹è¯•è¯¦æƒ… |
|------|:----:|----------|
| `patch` å•æ“ä½œ | âœ… é€šè¿‡ | æ”¯æŒ append/replace/delete ä¸‰ç§æ“ä½œ |
| `apply` æ‰¹é‡æ“ä½œ | âœ… é€šè¿‡ | YAML é…ç½®å¤šæ–‡ä»¶æ‰¹é‡ä¿®æ”¹ |
| `plan` é¢„è§ˆæ¨¡å¼ | âœ… é€šè¿‡ | Dry-run æ­£å¸¸å·¥ä½œï¼Œæ˜¾ç¤º diff |
| **å¹‚ç­‰æ€§** | ğŸ”´ **å¤±è´¥** | `append` æ“ä½œé‡å¤æ‰§è¡Œä¼šé‡å¤æ·»åŠ å†…å®¹ |
| Fingerprint éªŒè¯ | âœ… é€šè¿‡ | ç ´åæ€§æ“ä½œéœ€è¦ fingerprint æˆ– `--force` |
| åŸå­å†™å…¥ | âœ… é€šè¿‡ | ä½¿ç”¨ temp file + rename ä¿è¯åŸå­æ€§ |
| Diff è¾“å‡º | âš ï¸ éƒ¨åˆ† | å­˜åœ¨åŒæ–œæ è·¯å¾„é—®é¢˜ |
| JSON è¾“å‡º | âš ï¸ éƒ¨åˆ† | å­—æ®µå€¼ä¸º "unknown"ï¼Œæœªä»å®é™… operation è·å– |

### 2.2 è¯¦ç»†æµ‹è¯•è®°å½•

#### âœ… æµ‹è¯•é€šè¿‡ï¼šFingerprint å®‰å…¨æœºåˆ¶

```bash
# ç ´åæ€§æ“ä½œéœ€è¦ fingerprintï¼ˆæ­£ç¡®æŠ¥é”™ï¼‰
$ mdp patch -f doc.md -H "# Title ## API" --op replace -c "new"
Error: Destructive operation requires --force flag or fingerprint for safety

# æ­£ç¡®çš„ fingerprint éªŒè¯é€šè¿‡
$ mdp patch -f doc.md -H "# Title ## API" --op replace \
  -c "new" --fingerprint "TODO.*å¾…è¡¥å……" --format diff
# æ˜¾ç¤º diff é¢„è§ˆ
```

#### ğŸ”´ æµ‹è¯•å¤±è´¥ï¼šå¹‚ç­‰æ€§ç¼ºé™·

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
cat > test.md << 'EOF'
# æ–‡æ¡£

## ç« èŠ‚

- é¡¹ç›® A
EOF

# ç¬¬ä¸€æ¬¡ append
$ mdp patch -f test.md -H "# æ–‡æ¡£ ## ç« èŠ‚" --op append \
  -c "- é¡¹ç›® B" --force

# ç¬¬äºŒæ¬¡æ‰§è¡ŒåŒæ ·çš„ appendï¼ˆé¢„æœŸæ— å˜åŒ–ï¼Œå®é™…é‡å¤æ·»åŠ ï¼‰
$ mdp patch -f test.md -H "# æ–‡æ¡£ ## ç« èŠ‚" --op append \
  -c "- é¡¹ç›® B" --force

# ç»“æœï¼šé¡¹ç›® B å‡ºç°äº†ä¸¤æ¬¡ï¼
```

**å½±å“**ï¼šè¿èƒŒäº†å·¥å…·"å¹‚ç­‰"çš„æ ¸å¿ƒæ‰¿è¯ºï¼Œæ— æ³•å®‰å…¨åœ°åœ¨è‡ªåŠ¨åŒ–è„šæœ¬ä¸­ä½¿ç”¨ã€‚

**å»ºè®®ä¿®å¤**ï¼šåœ¨ `apply_append` ä¸­æ£€æµ‹ç›®æ ‡å†…å®¹æ˜¯å¦å·²å­˜åœ¨ï¼š

```rust
fn apply_append(content: &str, block: &Block, new_content: Option<&str>) -> Result<String> {
    let insert_content = match new_content {
        Some(c) => c,
        None => bail!("Append operation requires content"),
    };
    
    // å¹‚ç­‰æ€§æ£€æŸ¥ï¼šå¦‚æœå†…å®¹å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›åŸå†…å®¹
    if content[..block.end].contains(insert_content) {
        return Ok(content.to_string());
    }
    
    // ... åŸæœ‰é€»è¾‘
}
```

#### âš ï¸ æµ‹è¯•é—®é¢˜ï¼šDiff æ ¼å¼ç¼ºé™·

```bash
$ mdp patch -f test.md -H "# Title" --op append -c "test" --format diff
--- a//tmp/test.md      â† åŒæ–œæ é—®é¢˜
+++ b//tmp/test.md
```

é—®é¢˜å®šä½ï¼š`patch.rs` ç¬¬ 83 è¡Œ `generate_diff` å‡½æ•°ã€‚

#### âš ï¸ æµ‹è¯•é—®é¢˜ï¼šJSON è¾“å‡ºå­—æ®µç¼ºå¤±

```bash
$ mdp patch -f test.md -H "# Title" --op replace -c "x" --force --format json
{
  "success": true,
  "applied": true,
  "changes": [
    {
      "file": "unknown",        â† åº”ä¸ºå®é™…æ–‡ä»¶è·¯å¾„
      "operation": "patch",     â† åº”ä¸ºå…·ä½“æ“ä½œç±»å‹
      "heading": "unknown",     â† åº”ä¸ºå®é™… heading
      "index": 0,
      "status": "applied"
    }
  ]
}
```

é—®é¢˜å®šä½ï¼š`output.rs` ç¬¬ 54-69 è¡Œç¡¬ç¼–ç å€¼ã€‚

#### âš ï¸ æµ‹è¯•é—®é¢˜ï¼šAppend åæ ¼å¼é—®é¢˜

Append æ“ä½œåï¼Œæ–°å†…å®¹ä¸ä¸‹ä¸€ä¸ª heading ä¹‹é—´ç¼ºå°‘ç©ºè¡Œï¼š

```markdown
## åŠŸèƒ½ç‰¹æ€§

- åŸºç¡€åŠŸèƒ½ A

- æ–°å¢åŠŸèƒ½ C   â† append çš„å†…å®¹
## å®‰è£…æŒ‡å—    â† ç¼ºå°‘å‰ç½®ç©ºè¡Œ
```

---

## 3. CLI å¸®åŠ©è¯„ä¼°

### 3.1 å½“å‰å¸®åŠ©è¾“å‡º

```
$ mdp --help
Declarative, idempotent Markdown block patching tool

Usage: mdp <COMMAND>

Commands:
  patch  Apply a single patch operation
  apply  Apply patches from YAML configuration file
  plan   Preview changes without applying (dry-run)
  help   Print this message or the help of the given subcommand(s)

Options:
  -h, --help     Print help
  -V, --version  Print version
```

### 3.2 è¯„ä¼°

| æ–¹é¢ | è¯„åˆ† | è¯´æ˜ |
|------|:----:|------|
| åŸºæœ¬ç»“æ„ | â­â­â­â­ | å‘½ä»¤ã€å­å‘½ä»¤ã€å‚æ•°æ¸…æ™° |
| ç¤ºä¾‹å®Œæ•´æ€§ | â­â­â­ | ç¼ºå°‘å¸¸è§ç”¨ä¾‹ç¤ºä¾‹ |
| å‚æ•°è¯´æ˜ | â­â­â­ | heading path æ ¼å¼éœ€è¦æ›´å¤šç¤ºä¾‹ |
| YAML æ ¼å¼æ–‡æ¡£ | â­â­ | README å’Œå®é™…æ ¼å¼ä¸ä¸€è‡´ |

### 3.3 å‘ç°çš„é—®é¢˜

#### ğŸ”´ çŸ­é€‰é¡¹å†²çª

```
Options:
  -f, --file <FILE>
  -f, --fingerprint <FINGERPRINT>
  -f, --force
```

å¤šä¸ªé€‰é¡¹ä½¿ç”¨åŒä¸€ä¸ªçŸ­é€‰é¡¹ `-f`ï¼Œä¼šå¯¼è‡´è§£æé—®é¢˜ã€‚å»ºè®®ä½¿ç”¨ä¸åŒçš„çŸ­é€‰é¡¹ï¼š
- `-f, --file`
- `-p, --fingerprint` (æˆ–ç§»é™¤çŸ­é€‰é¡¹)
- `--force` (ä»…é•¿é€‰é¡¹)

### 3.4 æ”¹è¿›å»ºè®®

1. **æ·»åŠ  `--examples` é€‰é¡¹**ï¼š

```bash
$ mdp --examples

ç¤ºä¾‹ 1ï¼šåœ¨ç« èŠ‚åæ·»åŠ å†…å®¹
  mdp patch -f doc.md -H "## åŠŸèƒ½ç‰¹æ€§" --op append -c "- æ–°åŠŸèƒ½"

ç¤ºä¾‹ 2ï¼šå®‰å…¨æ›¿æ¢å†…å®¹ï¼ˆå¸¦ fingerprintï¼‰
  mdp patch -f doc.md -H "## API" --op replace \
    -c "æ–°æ–‡æ¡£" --fingerprint "TODO.*" --force

ç¤ºä¾‹ 3ï¼šæ‰¹é‡æ“ä½œ
  mdp plan patches.yaml    # é¢„è§ˆ
  mdp apply patches.yaml --force  # åº”ç”¨
```

2. **ä¿®æ­£ README ä¸­çš„ YAML æ ¼å¼**ï¼š

å½“å‰ README æ˜¾ç¤ºï¼š
```yaml
heading:
  - "# API Reference"    # éœ€è¦åŒ…å« #
```

å®é™…éœ€è¦çš„æ˜¯æ•°ç»„æ ¼å¼ï¼š
```yaml
heading:
  - "# API Reference"    # åŒ…å« #
  - "## OAuth2"          # å¤šçº§æ ‡é¢˜
```

---

## 4. ä»£ç å®¡æŸ¥

### 4.1 ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ main.rs      # CLI è§£æå’Œä¸»æµç¨‹
â”œâ”€â”€ config.rs    # YAML é…ç½®è§£æ
â”œâ”€â”€ parser.rs    # Markdown è§£æå™¨
â”œâ”€â”€ patch.rs     # è¡¥ä¸é€»è¾‘
â””â”€â”€ output.rs    # è¾“å‡ºæ ¼å¼åŒ–
```

ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»åˆç†ã€‚

### 4.2 å‘ç°çš„é—®é¢˜

#### `output.rs` ç¬¬ 127 è¡Œï¼šTypo

```rust
// é”™è¯¯
format!("-{}/n", old_lines[i])

// åº”ä¸º
format!("-{}/n", old_lines[i])  // æ³¨æ„ \n ä¸æ˜¯ /n
```

#### `parser.rs`ï¼šSection æŸ¥æ‰¾é€»è¾‘ç®€åŒ–

å½“å‰ `find_section` åªåŒ¹é…æœ€åä¸€ä¸ª headingï¼Œå¿½ç•¥å±‚çº§å…³ç³»ã€‚å¯èƒ½å¯¼è‡´è¯¯åŒ¹é…ï¼š

```markdown
# æ–‡æ¡£ A
## å­ç« èŠ‚

# æ–‡æ¡£ B
## å­ç« èŠ‚   â† æŸ¥æ‰¾ ["## å­ç« èŠ‚"] ä¼šåŒ¹é…åˆ°è¿™é‡Œï¼Œä½†å¯èƒ½æƒ³è¦ç¬¬ä¸€ä¸ª
```

å»ºè®®ï¼šè€ƒè™‘å®Œæ•´è·¯å¾„åŒ¹é…æˆ–æ·»åŠ å±‚çº§éªŒè¯ã€‚

---

## 5. ä¿®å¤å»ºè®®ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“ | ä¿®å¤éš¾åº¦ |
|:------:|------|:----:|:--------:|
| ğŸ”´ P0 | å¹‚ç­‰æ€§ç¼ºé™· | æ ¸å¿ƒæ‰¿è¯ºä¸æˆç«‹ | ä½ |
| ğŸŸ  P1 | JSON è¾“å‡ºå­—æ®µç¼ºå¤± | Agent é›†æˆå—é˜» | ä½ |
| ğŸŸ  P1 | çŸ­é€‰é¡¹å†²çª | CLI ä½¿ç”¨å›°æƒ‘ | ä½ |
| ğŸŸ¡ P2 | Diff æ ¼å¼é—®é¢˜ | è¾“å‡ºå¯è¯»æ€§ | ä½ |
| ğŸŸ¡ P2 | Append æ ¼å¼é—®é¢˜ | æ–‡æ¡£æ ¼å¼ç ´å | ä½ |
| ğŸŸ¢ P3 | æ–‡æ¡£å®Œå–„ | ç”¨æˆ·ä½“éªŒ | ä¸­ |

---

## 6. æµ‹è¯•å»ºè®®

å»ºè®®æ·»åŠ ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š

```rust
// 1. å¹‚ç­‰æ€§æµ‹è¯•
#[test]
fn test_append_idempotent() {
    let content = "# Title\n\n## Section\n\ncontent\n";
    // ç¬¬ä¸€æ¬¡ append
    let r1 = apply_append(content, &block, Some("new")).unwrap();
    // ç¬¬äºŒæ¬¡ append åŒæ ·å†…å®¹
    let r2 = apply_append(&r1, &block, Some("new")).unwrap();
    assert_eq!(r1, r2);  // åº”è¯¥ç›¸åŒ
}

// 2. è¾¹ç•Œæµ‹è¯•ï¼šç©ºæ–‡ä»¶ã€æ—  heading
// 3. å¹¶å‘å®‰å…¨æµ‹è¯•ï¼šå¤šè¿›ç¨‹åŒæ—¶ patch
// 4. å¤§æ–‡ä»¶æ€§èƒ½æµ‹è¯•
```

---

## 7. ç»“è®º

`mdp` å·¥å…·çš„è®¾è®¡ç†å¿µå…ˆè¿›ï¼Œé€‚åˆ AI Agent å·¥ä½œæµï¼Œä½†**å½“å‰ç‰ˆæœ¬ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒ**ï¼Œä¸»è¦åŸå› ï¼š

1. **å¹‚ç­‰æ€§ç¼ºé™·**ä¼šå¯¼è‡´é‡å¤ä¿®æ”¹
2. JSON è¾“å‡ºä¸å®Œæ•´ï¼Œå½±å“è‡ªåŠ¨åŒ–é›†æˆ
3. æ–‡æ¡£ä¸å®ç°å­˜åœ¨ä¸ä¸€è‡´

ä¿®å¤ P0-P1 é—®é¢˜åï¼Œè¯¥å·¥å…·å…·å¤‡è‰¯å¥½çš„ç”Ÿäº§å°±ç»ªåŸºç¡€ã€‚

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2026-02-20*
